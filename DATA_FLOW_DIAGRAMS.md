# ๐ Data Flow Diagrams - Before & After Fix

## ๐ด CURRENT BROKEN FLOW

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DOWNLOAD ZIP FROM HOTELBEDS                                โ
โ  โโ Full API: /hotel-cache-api/1.0/files                    โ
โ  โโ Size: ~700MB compressed โ ~15-20GB extracted            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  EXTRACT ZIP                                                โ
โ  โโ GENERAL/                  โ NOT PROCESSED              โ
โ  โ   โโ GHOT_F (Hotels)       โ IGNORED                    โ
โ  โ   โโ IDES_F (Destinations) โ IGNORED                    โ
โ  โ   โโ GCAT_F (Categories)   โ IGNORED                    โ
โ  โ   โโ GTTO_F (Chains)       โ IGNORED                    โ
โ  โ                                                           โ
โ  โโ DESTINATIONS/             โ PROCESSED                  โ
โ      โโ AYT/ (Antalya)        โ Rates, rooms, etc.         โ
โ      โโ DXB/ (Dubai)          โ Rates, rooms, etc.         โ
โ      โโ PMI/ (Palma)          โ Rates, rooms, etc.         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GENERATE CSVs                                              โ
โ  โโ hotels.csv                โ EMPTY (no GHOT_F parsing)  โ
โ  โโ destinations.csv          โ EMPTY (no IDES_F parsing)  โ
โ  โโ categories.csv            โ EMPTY (no GCAT_F parsing)  โ
โ  โโ chains.csv                โ EMPTY (no GTTO_F parsing)  โ
โ  โ                                                           โ
โ  โโ hotel_rates.csv           โ POPULATED                  โ
โ  โโ hotel_rooms.csv           โ POPULATED                  โ
โ  โโ hotel_inventory.csv       โ POPULATED                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  UPLOAD TO S3                                               โ
โ  โโ Missing: hotels.csv       โ                            โ
โ  โโ Missing: destinations.csv โ                            โ
โ  โโ Missing: categories.csv   โ                            โ
โ  โโ Has: hotel_*.csv          โ                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LOAD INTO AURORA (LOAD DATA FROM S3)                       โ
โ  โโ hotels table              โ EMPTY                      โ
โ  โโ destinations table        โ EMPTY                      โ
โ  โโ categories table          โ EMPTY                      โ
โ  โโ chains table              โ EMPTY                      โ
โ  โ                                                           โ
โ  โโ hotel_rates table         โ๏ธ  LOADED but orphaned       โ
โ  โโ hotel_rooms table         โ๏ธ  LOADED but orphaned       โ
โ  โโ hotel_inventory table     โ๏ธ  LOADED but orphaned       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  COMPUTE CHEAPEST PRICES                                    โ
โ                                                              โ
โ  Query:                                                      โ
โ  SELECT r.hotel_id, MIN(r.price)                            โ
โ  FROM hotel_rates r                                          โ
โ  INNER JOIN hotels h ON h.id = r.hotel_id  โ FAILS!        โ
โ                                                              โ
โ  Result: cheapest_pp table    โ EMPTY (JOIN fails)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                    โ FAILURE โ
      destinations table: NULL
      categories table: NULL
      cheapest_pp table: NULL
```

---

## โ FIXED FLOW (AFTER IMPLEMENTATION)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  DOWNLOAD ZIP FROM HOTELBEDS                                โ
โ  โโ Full API: /hotel-cache-api/1.0/files                    โ
โ  โโ Size: ~700MB compressed โ ~15-20GB extracted            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  EXTRACT ZIP                                                โ
โ  โโ GENERAL/                  โ NOW PROCESSED              โ
โ  โ   โโ GHOT_F (Hotels)       โ WILL PARSE                 โ
โ  โ   โโ IDES_F (Destinations) โ WILL PARSE                 โ
โ  โ   โโ GCAT_F (Categories)   โ WILL PARSE                 โ
โ  โ   โโ GTTO_F (Chains)       โ WILL PARSE                 โ
โ  โ                                                           โ
โ  โโ DESTINATIONS/             โ PROCESSED                  โ
โ      โโ AYT/ (Antalya)        โ Rates, rooms, etc.         โ
โ      โโ DXB/ (Dubai)          โ Rates, rooms, etc.         โ
โ      โโ PMI/ (Palma)          โ Rates, rooms, etc.         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  NEW: PARSE GENERAL FOLDER FIRST                            โ
โ                                                              โ
โ  generalDataParser.ts:                                      โ
โ  โโ Parse GHOT_F files                                      โ
โ  โ   Format: hotel_id:category:dest:chain:name:...          โ
โ  โ   โ hotels array                                         โ
โ  โ                                                           โ
โ  โโ Parse IDES_F files                                      โ
โ  โ   Format: dest_code:country:available:name               โ
โ  โ   โ destinations array                                   โ
โ  โ                                                           โ
โ  โโ Parse GCAT_F files                                      โ
โ  โ   Format: cat_code:type:simple:description               โ
โ  โ   โ categories array                                     โ
โ  โ                                                           โ
โ  โโ Parse GTTO_F files                                      โ
โ      Format: chain_code:chain_name                          โ
โ      โ chains array                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GENERATE CSVs (UPDATED ORDER)                              โ
โ                                                              โ
โ  STEP 1: GENERAL CSVs (NEW)                                 โ
โ  โโ hotels.csv                โ POPULATED (from GHOT_F)    โ
โ  โโ destinations.csv          โ POPULATED (from IDES_F)    โ
โ  โโ categories.csv            โ POPULATED (from GCAT_F)    โ
โ  โโ chains.csv                โ POPULATED (from GTTO_F)    โ
โ                                                              โ
โ  STEP 2: DESTINATIONS CSVs (EXISTING)                       โ
โ  โโ hotel_rates.csv           โ POPULATED                  โ
โ  โโ hotel_rooms.csv           โ POPULATED                  โ
โ  โโ hotel_inventory.csv       โ POPULATED                  โ
โ  โโ hotel_tax_info.csv        โ POPULATED (17 fields)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  UPLOAD TO S3                                               โ
โ  โโ hotels.csv                โ UPLOADED                   โ
โ  โโ destinations.csv          โ UPLOADED                   โ
โ  โโ categories.csv            โ UPLOADED                   โ
โ  โโ chains.csv                โ UPLOADED                   โ
โ  โโ hotel_*.csv (all)         โ UPLOADED                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LOAD INTO AURORA (CORRECT ORDER)                           โ
โ                                                              โ
โ  PHASE 1: Master Tables (No FK dependencies)                โ
โ  โโ 1. chains                 โ LOADED                     โ
โ  โโ 2. categories             โ LOADED                     โ
โ  โโ 3. destinations           โ LOADED                     โ
โ                                                              โ
โ  PHASE 2: Hotels (References master tables)                 โ
โ  โโ 4. hotels                 โ LOADED                     โ
โ                                                              โ
โ  PHASE 3: Hotel Details (References hotels)                 โ
โ  โโ 5. hotel_rates            โ LOADED (with FK)           โ
โ  โโ 6. hotel_rooms            โ LOADED (with FK)           โ
โ  โโ 7. hotel_inventory        โ LOADED (with FK)           โ
โ  โโ 8. hotel_tax_info         โ LOADED (with FK)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  VALIDATION (NEW STEP)                                      โ
โ                                                              โ
โ  Pre-compute checks:                                        โ
โ  โโ SELECT COUNT(*) FROM hotels         โ Must be > 0       โ
โ  โโ SELECT COUNT(*) FROM destinations   โ Must be > 0       โ
โ  โโ SELECT COUNT(*) FROM categories     โ Must be > 0       โ
โ  โโ SELECT COUNT(*) FROM hotel_rates    โ Must be > 0       โ
โ                                                              โ
โ  NULL checks:                                                โ
โ  โโ hotels.id IS NOT NULL               โ                  โ
โ  โโ hotels.name IS NOT NULL             โ                  โ
โ  โโ destinations.code IS NOT NULL       โ                  โ
โ  โโ hotel_rates.price > 0               โ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  COMPUTE CHEAPEST PRICES (NOW WORKS!)                       โ
โ                                                              โ
โ  Query:                                                      โ
โ  INSERT INTO cheapest_pp                                    โ
โ  SELECT r.hotel_id, MIN(r.price) * nights / 2 as price_pp  โ
โ  FROM hotel_rates r                                          โ
โ  INNER JOIN hotels h ON h.id = r.hotel_id  โ SUCCESS!      โ
โ  WHERE r.price > 0                                           โ
โ  GROUP BY r.hotel_id                                         โ
โ                                                              โ
โ  Result:                                                     โ
โ  โโ CITY_TRIP (2 nights)      โ 50,000+ hotels             โ
โ  โโ OTHER (5 nights)          โ 50,000+ hotels             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                    โ SUCCESS โ
      destinations table: POPULATED
      categories table: POPULATED
      cheapest_pp table: POPULATED
      Foreign keys: INTACT
      No NULL critical fields: VERIFIED
```

---

## ๐ IMPORT-ONLY FLOW (Already Extracted Data)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  USER: Already have extracted folder                        โ
โ  GET /api/v1/hotelbed/import-only?folder=hotelbed_cache_... โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FIND EXTRACTED FOLDER                                      โ
โ  โโ Check: downloads/hotelbed_cache_full_1699900000/        โ
โ  โโ Verify GENERAL/ exists                                  โ
โ  โโ Verify DESTINATIONS/ exists                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                 โญ๏ธ  SKIP DOWNLOAD
                 โญ๏ธ  SKIP EXTRACTION
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PARSE GENERAL FOLDER                                       โ
โ  โ Same as full flow                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  GENERATE CSVs                                              โ
โ  โ Same as full flow                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  UPLOAD TO S3                                               โ
โ  โ Same as full flow                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LOAD INTO AURORA                                           โ
โ  โ Same as full flow                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                    โ SUCCESS โ
```

---

## ๐ FILE STRUCTURE BREAKDOWN

### GENERAL Folder Files

```
GENERAL/
โโ GHOT_F_[OFFICE]_[ID]
โ  โ
โ  โ  Format: {GHOT}
โ  โ          hotel_id:category:destination_code:chain_code:...
โ  โ          {/GHOT}
โ  โ
โ  โโ Example:
โ     123456:4*:PMI:MELIA:HOTEL:10:N:ES:07:2.65:39.56:Hotel Melia Palma
โ
โโ IDES_F_[OFFICE]_[ID]
โ  โ
โ  โ  Format: {IDES}
โ  โ          dest_code:country_code:is_available:name
โ  โ          {/IDES}
โ  โ
โ  โโ Example:
โ     PMI:ES:Y:Palma de Mallorca
โ     DXB:AE:Y:Dubai
โ
โโ GCAT_F_[OFFICE]_[ID]
โ  โ
โ  โ  Format: {GCAT}
โ  โ          category_code:type:simple_code:description
โ  โ          {/GCAT}
โ  โ
โ  โโ Example:
โ     4*:HOTEL:4S:4 Star Hotel
โ     5*:HOTEL:5S:5 Star Hotel
โ
โโ GTTO_F_[OFFICE]_[ID]
   โ
   โ  Format: {GTTO}
   โ          chain_code:chain_name
   โ          {/GTTO}
   โ
   โโ Example:
      MELIA:Meliรก Hotels International
      HILTON:Hilton Worldwide
```

### DESTINATIONS Folder Files

```
DESTINATIONS/
โโ AYT/  (Antalya, Turkey)
โ  โโ AYT_1_56548_F
โ  โ  {CCON}  โ Contract header
โ  โ  {CNHA}  โ Room allocations
โ  โ  {CNCT}  โ Daily rates
โ  โ  {ATAX}  โ Tax rules (17 fields)
โ  โ  {/ATAX}
โ  โ
โ  โโ AYT_1_56549_F
โ  โโ ...
โ
โโ DXB/  (Dubai, UAE)
โ  โโ DXB_1_78910_F
โ  โโ ...
โ
โโ PMI/  (Palma, Spain)
   โโ PMI_1_12345_F
   โโ ...
```

---

## ๐ KEY INSIGHTS

### Problem Chain
```
No GENERAL parsing
    โ
Empty master tables
    โ
Foreign key JOINs fail
    โ
Cheapest price computation fails
    โ
API returns no data
```

### Solution Chain
```
Parse GENERAL folder
    โ
Populate master tables
    โ
Foreign key JOINs succeed
    โ
Cheapest price computation works
    โ
API returns complete data
```

---

## ๐ DATA DEPENDENCIES

```
chains (no dependencies)
  โ
categories (no dependencies)
  โ
destinations (no dependencies)
  โ
hotels (depends on: chains, categories, destinations)
  โ
hotel_* tables (all depend on: hotels)
  โ
cheapest_pp (depends on: hotels, hotel_rates)
```

---

**Visual Guide Version:** 1.0  
**Last Updated:** 2025-11-13  
**Purpose:** Understanding data flow and dependencies
