generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  SUPER_ADMIN
  COUPLE
  VENDOR
  BUSINESS_SPONSOR
  FAMILY_SPONSOR
}

enum TokenType {
  SIGNIN
  SIGNUP
  EMAIL_VERIFY
  PHONE_VERIFY
  TWO_FACTOR_AUTHENTICATION
  FORGOT_PASSWORD
}

/// Main hotel file record
model HotelBedFile {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  hotelMasters     HotelMaster[]
  boardMasters     BoardMaster[]
  contracts        Contract[]
  promotions       Promotion[]
  rooms            Room[]
  restrictions     Restriction[]
  inventories      Inventory[]
  costs            Cost[]
  minMaxStays      MinMaxStay[]
  supplements      Supplement[]
  stopSales        StopSale[]
  cancellationFees CancellationFee[]
  rateCodes        RateCode[]
  extraStays       ExtraStay[]
  extraSupplements ExtraSupplement[]
  groups           Group[]
  offers           Offer[]
  clients          Client[]
  validMarkets     ValidMarket[]
  handlingFees     HandlingFee[]
  taxes            Tax[]
}

/// Contract info (CCON) - 26 fields from documentation
model Contract {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  externalInventory String?
  destinationCode   String?
  officeCode        String?
  contractNumber    String?
  contractName      String?
  companyCode       String?
  serviceType       String?
  hotelCode         String?
  giataHotelCode    String?
  initialDate       DateTime?
  endDate           DateTime?
  noHotel           Boolean?
  currency          String?
  baseBoard         String?
  classification    String?
  paymentModel      String?
  dailyPrice        Boolean?
  releaseDays       Boolean?
  minChildAge       Int?
  maxChildAge       Int?
  opaque            Boolean?
  fixRate           Boolean?
  contractType      String?
  maxRooms          Int?
  hotelContent      String?
  sellingPrice      Boolean?
}

/// Promotions (CNPR) - 7 fields from documentation
model Promotion {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  code                    String?
  description             String?
  initialDate             DateTime?
  finalDate               DateTime?
  applicationInitialDate  DateTime?
  applicationFinalDate    DateTime?
  isIncluded              Boolean?
}

/// Room info (CNHA)
model Room {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  roomCode         String?
  characteristic   String?
  standardCapacity Int?
  minPax           Int?
  maxPax           Int?
  maxAdults        Int?
  maxChildren      Int?
  maxInfants       Int?
  minAdults        Int?
  minChildren      Int?
}

/// Restrictions (CNIN) - Original restriction data
model Restriction {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate       DateTime?
  endDate         DateTime?
  roomCode        String?
  characteristic  String?
  rateCode        String?
  releaseDays     Int?
  allotment       Int?
  inventoryTuples String?  @db.Text
}

/// Inventory Management (Derived from CNIN for client requirement)
model Inventory {
  id              String       @id @default(uuid())
  hotelBedId      String
  hotelBedFile    HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt       DateTime     @default(now())

  calendarDate    DateTime     // Date for which inventory is tracked
  hotelCode       String?      // Hotel identifier
  roomCode        String?      // Room type
  characteristic  String?      // Room characteristic
  ratePlanId      String?      // Rate plan/code
  allotment       Int?         // Available room count
  stopSale        Boolean?     // Stop sale flag
  releaseDays     Int?         // Release days before check-in
  cta             Int?         // Close to arrival (days)
  ctd             Int?         // Close to departure (days)
  minNights       Int?         // Minimum nights required
  maxNights       Int?         // Maximum nights allowed

  @@index([calendarDate, hotelCode])
  @@index([hotelCode, roomCode, calendarDate])
}

/// Costs/Prices (CNCT)
model Cost {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate       DateTime?
  endDate         DateTime?
  roomCode        String?
  characteristic  String?
  genericRate     Float?
  marketPriceCode String?
  perPaxFlag      Boolean?
  netPrice        Float?
  publicPrice     Float?
  specificRate    String?
  boardCode       String?
  amount          Float?
  validFrom       DateTime?
  validTo         DateTime?
}

/// Minimum and maximum stay rules (CNEM)
model MinMaxStay {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate      DateTime?
  endDate        DateTime?
  checkInFlag    Boolean?   // T/F flag
  perDateFlag    Boolean?   // T/F flag
  roomCode       String?
  characteristic String?
  boardCode      String?
  minNights      Int?       // Minimum nights required
  maxNights      Int?       // Maximum nights allowed
  monFlag        Boolean?   // Monday applicable
  tueFlag        Boolean?   // Tuesday applicable
  wedFlag        Boolean?   // Wednesday applicable
  thuFlag        Boolean?   // Thursday applicable
  friFlag        Boolean?   // Friday applicable
  satFlag        Boolean?   // Saturday applicable
  sunFlag        Boolean?   // Sunday applicable
  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

/// Supplements (CNSR) - Currently empty in data but defined in documentation
model Supplement {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate            DateTime?
  endDate              DateTime?
  boardCode            String?
  perPaxFlag           Boolean?
  amountSupplement     Float?
  percentageSupplement Float?
  rateCode             String?
  roomCode             String?
  characteristic       String?
  minAge               Int?
  maxAge               Int?
  monFlag              Boolean?
  tueFlag              Boolean?
  wedFlag              Boolean?
  thuFlag              Boolean?
  friFlag              Boolean?
  satFlag              Boolean?
  sunFlag              Boolean?
  netPrice             Float?
  publicPrice          Float?
  marketPrice          Float?
}

/// Stop sales (CNPV) - Currently empty in data but defined in documentation
model StopSale {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate      DateTime?
  endDate        DateTime?
  rateCode       String?
  roomCode       String?
  characteristic String?
  boardCode      String?
  stopSalesFlag  Boolean?
}

/// Cancellation fees (CNCF)
model CancellationFee {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate         DateTime?
  endDate           DateTime?
  rateCode          String?
  daysBeforeCheckin Int?
  chargeType        String?
  amount            Float?
  amountFrom        Float?    // field_7 - Additional amount/percentage field
  amountTo          Float?    // field_8 - Additional amount/percentage field
  percentage        Float?
  languageCode      String?   // field_11 - Language code (e.g., "EN")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

/// Rate codes (CNTA)
model RateCode {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  rateCode    String?
  description String?
}

/// Extra stay info (CNES)
model ExtraStay {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate      DateTime?
  endDate        DateTime?
  roomCode       String?
  characteristic String?
  checkInFlag    Boolean?
  checkOutFlag   Boolean?
}

/// Extra supplements (CNSU)
model ExtraSupplement {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  startDate         DateTime?
  endDate           DateTime?
  lastUpdate        DateTime?
  releaseEndDate    String?
  supplementCode    String?
  chargeType        String?
  mandatoryFlag     Boolean?
  includedFlag      Boolean?
  daysBeforeCheckin Int?
  applicability     String?
  amount            Float?
  description       String?
  perPaxFlag        Boolean?
  roomType          String?
  rateCode          String?
  boardCode         String?
  characteristic    String?
  minPax            Int?
  maxPax            Int?
  minAge            Int?
  maxAge            Int?
  monFlag           Boolean?
  tueFlag           Boolean?
  wedFlag           Boolean?
  thuFlag           Boolean?
  friFlag           Boolean?
  satFlag           Boolean?
  sunFlag           Boolean?
  netPrice          Float?
  publicPrice       Float?
}

/// Groups (CNGR)
model Group {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  groupCode   String?
  description String?
}

/// Offers (CNOE)
model Offer {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])

  offerCode   String?
  description String?
}

/// Client/Names (CNNH) - No hotel contracts
model Client {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  clientCode String?
  clientName String?
  clientType String?
  activeFlag Boolean?
}

/// Valid Markets (CNCL) - 2 fields from documentation
model ValidMarket {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  countryCode      String?
  validForCountry  Boolean?
}

/// Handling Fees (CNHF) - 13 fields from documentation
model HandlingFee {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  initialDate  DateTime?
  finalDate    DateTime?
  code         String?
  rate         String?
  type         String?
  amount       Float?
  percentage   Float?
  adultAmount  Float?
  childAmount  Float?
  minimumAge   Int?
  maximumAge   Int?
  ageAmount    Float?
  isPerService Boolean?
}

/// Tax Breakdown (ATAX) - 17 fields from documentation
model Tax {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  initialDate            DateTime?
  finalDate              DateTime?
  roomCode               String?
  boardCode              String?
  taxCode                String?
  includedInPrice        Boolean?
  maximumNumberOfNights  Int?
  minimumAge             Int?
  maximumAge             Int?
  isPerNight             Boolean?
  isPerPax               Boolean?
  amount                 Float?
  percentage             Float?
  currency               String?
  applyOver              String?
  marketCode             String?
  legalDescription       String?
}
model Role {
  id        String   @id @default(uuid())
  code      RoleName @unique
  isActive  Boolean  @default(true)
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  users User[]
}
model User {
  id           String       @id @default(uuid())
  email        String       @unique
  password     String
  firstName    String?
  lastName     String?
  // dateofbirth  String?
  userName     String?
  phoneNumber  String?
  profileImage String?
  // type         String?
  roleId       String
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)
  isDeleted    Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt
  keystores    Keystore[]
  tokenstore   Tokenstore[]

  @@index([roleId])
}
model Keystore {
  id           String   @id @default(uuid())
  primaryKey   String
  secondaryKey String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  clientId String?
  client   User?   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Prevent duplicate keys per client (optional but recommended)
  // @@unique([clientId, primaryKey])
}

model Tokenstore {
  id        String    @id @default(uuid())
  type      TokenType
  token     String    @unique
  shortCode String? // optional; can be used for OTP/short codes
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  expireAt  DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // If you want shortCode unique when present:
  @@unique([type, shortCode])
  @@index([type, userId])
}

/// Hotel Master Information (HOTEL)
model HotelMaster {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  hotelCode          String?
  hotelCategory      String?
  destinationCode    String?
  chainCode          String?
  contractMarket     String?
  ranking            String?
  noHotelFlag        Boolean?
  countryCode        String?
  accommodationType  String?
  accommodationCode  String?
  latitude           String?
  longitude          String?
  hotelName          String?
}

/// Board Master Information (BOARD)
model BoardMaster {
  id           String       @id @default(uuid())
  hotelBedId   String
  hotelBedFile HotelBedFile @relation(fields: [hotelBedId], references: [id])
  createdAt    DateTime     @default(now())

  boardCode String?
  boardType String?
  boardName String?
}

// ============================================================================
// DERIVED TABLES FOR CACHE API (per client requirements)
// ============================================================================

/// Cheapest Price Per Person - Precomputed for fast "From â‚¬ p.p." display
model CheapestPricePerPerson {
  id           String   @id @default(uuid())
  
  // Keys
  hotelCode    String
  categoryTag  String   // e.g., "city_trip", "other", "beach"
  startDate    DateTime // First bookable date
  nights       Int      // Number of nights
  
  // Result
  boardCode    String?  // Board type (e.g., RO, BB, HB, FB)
  pricePP      Float    // Price per person (double occupancy)
  currency     String   @default("EUR")
  
  // References
  ratePlanId   String?
  roomCode     String?
  contractId   String?
  
  // Metadata
  derivedAt    DateTime @default(now())
  expiresAt    DateTime? // Optional TTL for cache invalidation
  
  @@index([hotelCode, categoryTag])
  @@index([categoryTag, pricePP])
  @@index([startDate])
  @@index([derivedAt])
  @@unique([hotelCode, categoryTag, startDate, nights])
}

/// Search Index - Aggregated data for fast filtering and sorting
model SearchIndex {
  id              String   @id @default(uuid())
  
  // Keys
  hotelCode       String   @unique
  destinationCode String?
  countryCode     String?
  zoneCode        String?
  
  // Hotel Info
  hotelName       String?
  categoryTag     String?  // Travel category
  rating          Float?
  chainCode       String?
  accommodationType String?
  
  // Price aggregates
  minPricePP      Float?
  maxPricePP      Float?
  avgPricePP      Float?
  
  // Location
  latitude        Float?
  longitude       Float?
  beachDistanceM  Int?
  centerDistanceM Int?
  
  // Availability flags
  hasAvailability Boolean  @default(false)
  hasPromotion    Boolean  @default(false)
  lastMinute      Boolean  @default(false)
  
  // Metadata
  lastUpdated     DateTime @default(now())
  
  @@index([destinationCode, categoryTag, minPricePP])
  @@index([countryCode])
  @@index([hasAvailability, hasPromotion])
  @@fulltext([hotelName])
}

/// Hotel Amenities (many-to-many)
model HotelAmenity {
  id           String   @id @default(uuid())
  hotelCode    String
  amenityCode  String   // e.g., "WIFI", "POOL", "SPA", "PARKING"
  amenityName  String?
  createdAt    DateTime @default(now())
  
  @@unique([hotelCode, amenityCode])
  @@index([amenityCode])
}

/// Foreign Exchange Rates for multi-currency support
model FxRate {
  id           String   @id @default(uuid())
  date         DateTime
  fromCurrency String
  toCurrency   String
  rate         Float
  createdAt    DateTime @default(now())
  
  @@unique([date, fromCurrency, toCurrency])
  @@index([date])
}

// ============================================================================
// STAGING TABLES (for idempotent ingestion)
// ============================================================================

/// Staging table for raw ingest data before merging
model StagingIngest {
  id              String   @id @default(uuid())
  batchId         String   // Unique batch identifier
  section         String   // API section (e.g., HOTEL, CCON, CNIN)
  rawData         String   @db.LongText // JSON blob of raw data
  hash            String   // MD5/SHA256 hash for delta detection
  lastModified    DateTime?
  ingestedAt      DateTime @default(now())
  processed       Boolean  @default(false)
  
  @@index([batchId, section])
  @@index([processed])
  @@index([ingestedAt])
}

// ============================================================================
// ENHANCEMENTS TO EXISTING MODELS
// ============================================================================