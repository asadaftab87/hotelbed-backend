name: EC2 Node.js Backend CI/CD

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy Node.js Backend to EC2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Use Node.js version from .nvmrc
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "-----------------------------"
            echo "ğŸ“‚ Moving to project directory"
            cd /home/ec2-user/hotelbed-backend

            echo "-----------------------------"
            echo "â¬‡ï¸ Pulling latest code from master..."
            git reset --hard 
            git checkout master
            git reset --hard
            git pull origin master

            echo "-----------------------------"
            echo "ğŸ“¦ Installing dependencies..."
            npm install --legacy-peer-deps

            echo "-----------------------------"
            echo "ğŸ“¦ Generating Prisma..."
            npx prisma generate

            echo "-----------------------------"
            echo "ğŸ—ï¸ Building backend app..."
            npm run build

            echo "-----------------------------"
            echo "ğŸ”„ Restarting app with PM2..."
            
            # Stop all processes
            pm2 delete all || true
            
            # Set NODE_OPTIONS for guaranteed heap size
            export NODE_OPTIONS="--max-old-space-size=24576 --expose-gc --max-semi-space-size=64"
            
            # Add to bashrc for persistence
            grep -qxF 'export NODE_OPTIONS="--max-old-space-size=24576 --expose-gc"' ~/.bashrc || \
            echo 'export NODE_OPTIONS="--max-old-space-size=24576 --expose-gc"' >> ~/.bashrc
            
            # Start with ecosystem.config.js
            pm2 start ecosystem.config.js
            pm2 save
            
            # Verify heap size applied
            echo ""
            echo "ğŸ” Verifying heap size..."
            ps aux | grep "dist/src/app.js" | grep -v grep || echo "Process starting..."
            
            echo ""
            echo "ğŸ“Š PM2 Status:"
            pm2 list
            
            echo "-----------------------------"
            echo "ğŸ‰ Deployment successful!"
            echo "âœ… Heap size: 24GB configured"
            echo "âœ… Batch size: 20,000 files"
            echo "âœ… Expected import time: 13-15 minutes"
